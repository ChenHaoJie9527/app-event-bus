# 单元测试文档

## 测试概述

本项目的单元测试主要测试modal打开和关闭的事件系统逻辑，包括事件发射、监听和handler方法的触发。

## 架构设计

### EventBus设计原则
- **纯粹的事件总线**: EventBus只负责事件的监听和调度，不处理任何业务逻辑
- **类型安全**: 使用TypeScript确保事件类型和数据的类型安全
- **异步支持**: 支持同步和异步监听器
- **错误处理**: 即使某个监听器出错，其他监听器仍能正常执行
- **监听器管理**: 提供完整的监听器生命周期管理

## 测试文件结构

```
src/test/
├── modal.test.ts      # Modal相关功能测试
├── event-bus.test.ts  # 事件总线集成测试
└── README.md          # 测试文档
```

## 测试覆盖范围

### 1. Modal事件系统测试 (`modal.test.ts`)

#### 事件发射和监听测试
- ✅ 测试 `modal:open` 事件的发射和监听
- ✅ 测试 `modal:close` 事件的发射和监听
- ✅ 测试同一事件的多个监听器
- ✅ 测试不同modal ID的事件处理

#### Modal Handler集成测试
- ✅ 测试 `openModal` handler在 `modal:open` 事件触发时的调用
- ✅ 测试 `closeModal` handler在 `modal:close` 事件触发时的调用
- ✅ 测试打开和关闭事件的顺序执行

#### 事件总线行为测试
- ✅ 测试无监听器时的优雅处理
- ✅ 测试异步监听器的正确处理
- ✅ 测试并行事件的并发处理

#### 类型安全测试
- ✅ 测试事件数据类型的正确性
- ✅ 测试事件映射类型的验证

### 2. 事件总线集成测试 (`event-bus.test.ts`)

#### 核心功能测试
- ✅ 测试EventBus实例创建
- ✅ 测试监听器注册和触发
- ✅ 测试多种事件类型处理
- ✅ 测试错误处理机制（改进：所有监听器都会执行）

#### 监听器管理测试
- ✅ 测试监听器ID的生成和唯一性
- ✅ 测试监听器的精确移除（通过ID）
- ✅ 测试监听器计数和状态检查
- ✅ 测试批量清理功能

#### 事件数据验证测试
- ✅ 测试事件数据结构的正确传递
- ✅ 测试不同modal ID的处理



#### 并发事件处理测试
- ✅ 测试并发事件的正确处理
- ✅ 测试混合事件类型的并发处理

#### 性能和内存测试
- ✅ 测试大量监听器的效率
- ✅ 测试重复事件发射的内存泄漏防护

#### 类型安全集成测试
- ✅ 测试事件名称的类型安全
- ✅ 测试事件数据的类型安全

## 测试策略

### 1. 隔离测试
- 每个测试用例都使用独立的EventBus实例
- 使用 `beforeEach` 重置测试状态
- Mock console.log来捕获输出

### 2. 异步测试
- 使用 `async/await` 处理异步事件发射
- 测试异步监听器的正确等待
- 测试并发事件的处理

### 3. 错误处理测试
- 测试监听器抛出错误时的行为
- 验证错误被正确传播
- 测试边界情况的处理

### 4. 类型安全测试
- 验证TypeScript类型约束
- 测试事件映射的正确性
- 确保编译时类型检查

## 运行测试

```bash
# 运行所有测试
npm run test:watch -- --run

# 或者直接使用vitest
npx vitest run src/test/

# 监听模式
npx vitest src/test/
```

## 测试结果

当前测试覆盖了以下核心功能：

1. **事件系统核心功能** (30个测试用例全部通过)
   - 事件发射和监听 ✅
   - Modal handler集成 ✅
   - 错误处理（改进） ✅
   - 并发处理 ✅
   - 类型安全 ✅
   - 监听器管理 ✅

2. **关键测试场景**
   - Modal打开/关闭事件的完整流程
   - 事件数据的正确传递
   - Handler方法的准确触发
   - 多监听器的并发执行
   - 错误情况的优雅处理

## 测试质量指标

- **测试覆盖率**: 覆盖了所有核心功能模块
- **测试稳定性**: 所有测试用例都能稳定通过
- **测试可维护性**: 测试代码结构清晰，易于理解和维护
- **类型安全**: 通过TypeScript确保类型安全

## 扩展建议

1. **添加更多边界情况测试**
   - 空字符串modalId的处理
   - 特殊字符modalId的处理
   - 极长modalId的处理

2. **性能测试**
   - 大量事件的性能基准测试
   - 内存使用情况的监控

3. **集成测试**
   - 与实际UI组件的集成测试
   - 端到端的事件流程测试 